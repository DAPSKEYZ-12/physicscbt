<!DOCTYPE html>
<html>
<head>
  <style>
    :root { 
      --utme-blue: #003366; 
      --utme-accent: #0056b3;
      --utme-green: #2e7d32; 
      --bg-light: #f8f9fa;
    }
    
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-light); margin: 0; user-select: none; color: #333; }

    /* MOBILE RESPONSIVE ADAPTATION */
    @media (max-width: 768px) {
      .container { flex-direction: column !important; padding: 10px !important; }
      .welcome-card { padding: 20px !important; width: 90% !important; }
      .header { padding: 10px !important; font-size: 14px; }
      #timer { font-size: 16px !important; }
      .question-area { padding: 20px !important; }
      .navigation-area { width: 100% !important; box-sizing: border-box; }
      .num-grid { grid-template-columns: repeat(8, 1fr) !important; } /* More columns for phone bottom bar */
    }

    #instructions { 
      position: fixed; inset: 0; 
      background: linear-gradient(135deg, var(--utme-blue) 0%, #001a33 100%); 
      z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 20px;
    }

    .welcome-card {
      background: white; width: 100%; max-width: 600px; padding: 40px; border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3); text-align: center;
    }

    .exam-details { display: flex; justify-content: space-around; background: #f0f4f8; padding: 15px; border-radius: 10px; margin: 20px 0; }
    .detail-item { display: flex; flex-direction: column; }
    .detail-label { font-size: 10px; color: #666; text-transform: uppercase; }
    .detail-value { font-weight: bold; font-size: 16px; color: var(--utme-blue); }

    .warning-box { background: #fff5f5; border-left: 4px solid #f56565; padding: 12px; margin: 20px 0; text-align: left; font-size: 13px; }

    .start-btn { 
      width: 100%; padding: 16px; background: var(--utme-green); color: white; 
      border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; 
    }

    .header { background: var(--utme-blue); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
    #timer { font-family: monospace; font-size: 22px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 5px; }

    .container { display: flex; padding: 25px; gap: 25px; max-width: 1200px; margin: 0 auto; }
    .question-area { flex: 3; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 300px; }
    .navigation-area { flex: 1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    
    .num-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; }
    .num-btn { padding: 10px 2px; border: 1px solid #dee2e6; text-align:center; cursor: pointer; background: #f8f9fa; border-radius: 4px; font-size: 12px; }
    .num-btn.answered { background: var(--utme-green); color: white; border-color: var(--utme-green); }
    .num-btn.active { border: 2px solid var(--utme-blue); color: var(--utme-blue); }
    
    .btn-group { margin-top: 30px; display: flex; gap: 10px; }
    .btn-nav { padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; font-weight: 600; flex: 1; }
    .btn-next { background: var(--utme-blue); color: white; border: none; }
  </style>
</head>
<body>

  <div id="instructions">
    <div class="welcome-card">
      <h1>D-MATHS EXAM</h1>
      <div class="exam-details">
        <div class="detail-item"><span class="detail-label">Items</span><span class="detail-value">40</span></div>
        <div class="detail-item"><span class="detail-label">Time</span><span class="detail-value">40m</span></div>
        <div class="detail-item"><span class="detail-label">Subject</span><span class="detail-value">Physics</span></div>
      </div>
      <div class="warning-box">
        <strong>SECURITY:</strong> Auto-submit after 5 tab switches.
      </div>
      <button class="start-btn" onclick="startExam()">START TEST</button>
    </div>
  </div>

  <div class="header">
    <div><strong>D-MATHS CBT</strong></div>
    <div id="timer">40:00</div>
    <button onclick="submitExam()" style="background: #c53030; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Submit</button>
  </div>

  <div class="container">
    <div class="question-area" id="quiz-box">
      <h3 id="q-text" style="font-size: 18px;">Fetching Questions...</h3>
      <div id="options-list"></div>
      <div class="btn-group">
        <button class="btn-nav" onclick="prevQ()">Back</button>
        <button class="btn-nav btn-next" onclick="nextQ()">Next</button>
      </div>
    </div>

    <div class="navigation-area">
      <h4 style="margin:0; font-size: 14px;">Navigator</h4>
      <div id="num-grid" class="num-grid"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let questions = [];
    let currentIdx = 0;
    let userAnswers = {};
    let tabViolations = 0;
    let timeLeft = 40 * 60;

    // IMPORTANT: REPLACE THE URL BELOW WITH YOUR DEPLOYED WEB APP URL
    const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

    async function startExam() {
      document.getElementById('instructions').style.display = 'none';
      try {
        const response = await fetch(WEB_APP_URL + "?getQuestions=true");
        questions = await response.json();
        renderQuestion();
        renderGrid();
        startTimer();
      } catch (e) {
        alert("Error loading questions. Ensure you pasted the correct Web App URL in the code.");
        console.error(e);
      }
    }

    // Security and Navigation logic remains exactly the same
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        tabViolations++;
        alert(`Warning! Violations: ${tabViolations}/5`);
        if (tabViolations >= 5) submitExam();
      }
    });

    function renderQuestion() {
      if(!questions[currentIdx]) return;
      const q = questions[currentIdx];
      document.getElementById('q-text').innerText = `Q${currentIdx + 1}: ${q.question}`;
      let html = "";
      q.options.forEach((opt, i) => {
        const letter = String.fromCharCode(65 + i);
        const checked = userAnswers[currentIdx] === letter ? 'checked' : '';
        html += `<div style="margin-bottom: 10px; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fafafa">
                  <label style="display: block; cursor: pointer;">
                    <input type="radio" name="opt" value="${letter}" ${checked} onchange="saveAnswer('${letter}')"> 
                    <strong>${letter}.</strong> ${opt}
                  </label>
                </div>`;
      });
      document.getElementById('options-list').innerHTML = html;
    }

    function saveAnswer(val) { userAnswers[currentIdx] = val; renderGrid(); }
    function renderGrid() {
      let html = "";
      questions.forEach((_, i) => {
        let status = userAnswers[i] ? 'answered' : '';
        let active = currentIdx === i ? 'active' : '';
        html += `<div class="num-btn ${status} ${active}" onclick="goToQ(${i})">${i + 1}</div>`;
      });
      document.getElementById('num-grid').innerHTML = html;
    }

    function goToQ(i) { currentIdx = i; renderQuestion(); renderGrid(); }
    function nextQ() { if(currentIdx < 39) goToQ(currentIdx + 1); }
    function prevQ() { if(currentIdx > 0) goToQ(currentIdx - 1); }

    function startTimer() {
      const interval = setInterval(() => {
        if (timeLeft <= 0) { clearInterval(interval); submitExam(); }
        timeLeft--;
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        document.getElementById('timer').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
      }, 1000);
    }

    function submitExam() {
      let score = 0;
      questions.forEach((q, i) => { if (userAnswers[i] === q.answer) score++; });
      generatePDF(score);
      alert("Submitted!");
      window.location.reload();
    }

    function generatePDF(score) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("D-MATHS DIAGNOSING EXAM RESULT", 20, 20);
      doc.text(`Score: ${score} / 40`, 20, 40);
      doc.save("D-MATHS-Result.pdf");
    }

    async function submitExam() {
  let score = 0;
  questions.forEach((q, i) => {
    if (userAnswers[i] === q.answer) score++;
  });

  // 1. Send score to Google Sheet
  try {
    await fetch(WEB_APP_URL + "?score=" + score);
  } catch (e) {
    console.log("Could not record score to sheet, but downloading PDF anyway.");
  }

  // 2. Download the Result PDF
  generatePDF(score);

  alert("Exam Submitted Successfully! Your result is downloading.");
  window.location.reload();
}
  </script>
</body>
</html>
